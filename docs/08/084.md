# 스트림을 두 번 소비
스트림 API를 사용하다 보면 종종 스트림을 두 번 소비하는 상황이 벌어진다.
스트림 객체를 호출 체인 방식으로 사용할 때에는 이 문제에서 자유롭다.
그러나 스트림을 변수에 저장하려 한다면 이 문제에 주의를 기울일 필요가 있다.
대표적인 사례는 스트림 객체 변수에 조건부로 연산 단계를 추가하는 경우다.
가령 다음과 같이 첫 번째 스트림 원소를 조건에 따라 건너 뛴다고 가정해보자.

```java
void process(List<String> strings, boolean skipHeader) {
    Stream<String> stream = strings.stream();
    
    if (skipHeader) {
        stream.skip(1);
    }
    
    List<String> trimmed = stream.map(String::trim).toList();
    ...
}
```
중간 연산이 기존 객체를 수정하고 다시 반환하는 일은 거의 없다. 
대신 새로운 객체를 생성하고 원래 객체를 '소비됨'으로 표시하는 경우가 많다.
따라서 `skipHelper`가 `true`일 경우 스트림을 두 번 소비하게 되고 런타임에서 `IllegalStateException` 예외가 발생한다.
이 문제를 해결하려면 if 문 안에서 다음과 같이 스트림 변수를 재할당해야 한다.

```java
Stream<String> stream = strings.stream();
if (skipHelper) {
    stream = stream.skip(1);
}
```
또 다른 방법은 다음과 같이 0번 건너뛰는 조건을 함께 설정하는 것이다.
```java
List<String> stream = strings.stream()
        .skip(skipHelper ? 1 : 0)
        .map(String::trim)
        .toList();
```

다음과 같이 스트림을 재사용하는 코드도 간혹 발견된다.
```java
if (stream.count() == 0 || stream.anyMatch(String::isEmpty)) {
    ...
}
```
`anyMatch()`를 실행하기 전에 `count()`라는 단말 연산을 실행하며 스트림을 소비하기 때문이다.
이러한 과제는 일반적인 스트림 API로 쉽게 해결할 수 없다.
중간 컬렉션을 두고 스트림 원소를 수집하거나, 루프를 사용하거나, 서드파티 라이브러리 등의 대안을 찾아야 한다.

루프 안에서 스트림을 재사용하는 시나리오도 매우 위험하다.
예를 들어 두 개의 문자열 리스트인 `list`, `substrings`가 있다고 가정해보자.
`substrings`에 담긴 문자열이 `list`의 문자열에 포함된 경우, `list`의 문자열에 공백을 제거한 다음 이어 붙여서 출력하려 한다.

```java
static void print(List<String> list, List<String> substrings) {
    Stream<String> strings = list.stream().map(String::trim);

    for (String substring : substrings) {
        String text = "String that contain '" + substring + "': " + strings.filter(s -> s.contains(substring))
                .collect(Collectors.joining(", "));
        System.out.println(text);
    }
}
```

이 코드에서 작성자는 하나의 스트림을 루프 안팎에서 재사용하려 했다.
아마도 루프 안에서 반복적으로 수행하는 연산을 루프 밖으로 옮기려 했을 것이다.
그러나 이 코드는 제대로 작동하지 않는다.
첫 번째 반복에서 스트림이 소비되고 더 이상 사용할 수가 없기 때문이다.
`substring` 리스트에 하나의 항목만 있다면 이 문제는 발견하기 어렵다.

```java
print(List.of("Java", " Stream", " API"), List.of("a"));
```
그러나 이 테스트에 `substrings` 파라미터에 `List.of("a", "b")`를 전달하려면 `IllegalStateException`이 발생할 것이다.

> 실수 방지 가이드
* 스트림을 변수에 저장하지 않는다. 가능하면 전체 스트림 작업을 하나의 호출 체인으로 표현한다.
* 스트림을 변수에 저장하고 서로 다른 코드 분기에서 각각 사용할 때, 스트림을 두 번 소비할수 없다는 점을 명심해야 한다.
유닛 테스트로 모든 분기를 검사하고 루프가 있을 경우 최소 두 번이상 반복되는지 확인해야 한다.